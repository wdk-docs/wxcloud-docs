

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>7.3. 模板消息 &mdash; wxcloud 2019.04.09 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="7.4. 微信支付" href="pay.html" />
    <link rel="prev" title="7.2. 小程序码" href="qrcode.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> wxcloud
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../basis/index.html">1. 基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/index.html">2. 指引</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">3. 参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client-api/index.html">4. 小程序端 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server-api/index.html">5. 服务端 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sdk/index.html">6. SDK</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">7. 最佳实践</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="user.html">7.1. 用户管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="qrcode.html">7.2. 小程序码</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">7.3. 模板消息</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">7.3.1. 功能概述</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">7.3.2. 体验功能</a></li>
<li class="toctree-l3"><a class="reference internal" href="#demo">7.3.3. 体验 DEMO</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">7.3.4. DEMO 接入流程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">7.3.5. 源码介绍</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id6">7.3.5.1. 自定义消息模板</a></li>
<li class="toctree-l4"><a class="reference internal" href="#wx-js-utils">7.3.5.2. 使用 wx-js-utils 发送模板消息</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">7.3.5.3. 统一服务消息</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">7.3.5.4. 使用 wx-js-utils 接口发送统一服务消息</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="pay.html">7.4. 微信支付</a></li>
<li class="toctree-l2"><a class="reference internal" href="video-audio.html">7.5. 音视频</a></li>
<li class="toctree-l2"><a class="reference internal" href="smart-image.html">7.6. 智能图像</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">8. 常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">9. 术语表</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">wxcloud</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">7. 最佳实践</a> &raquo;</li>
        
      <li>7.3. 模板消息</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/practice/tmpmsg.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>7.3. 模板消息<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<div class="section" id="id2">
<h2>7.3.1. 功能概述<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>使用 wx-js-utils 接口发送统一服务消息
本文主要介绍模板消息功能，它类似一个访客预约系统，当用户预约成功后，下发一条消息，这条消息可以是单纯的小程序模板消息，如果小程序与公众号进行了关联，那么也可以使用统一服务消息，按需发送小程序的模板消息或是公众号的模板消息。</p>
</div>
<div class="section" id="id3">
<h2>7.3.2. 体验功能<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<img alt="https://main.qcloudimg.com/raw/c3bffdddfa54ecd95b5a569b10f71840.png" src="https://main.qcloudimg.com/raw/c3bffdddfa54ecd95b5a569b10f71840.png" />
</div>
<div class="section" id="demo">
<h2>7.3.3. 体验 DEMO<a class="headerlink" href="#demo" title="永久链接至标题">¶</a></h2>
<p>本章的案例代码，请参考 代码 <a class="reference external" href="https://github.com/TencentCloudBase/tcb-demo-basic">tcb-demo-basic</a> 。</p>
</div>
<div class="section" id="id4">
<h2>7.3.4. DEMO 接入流程<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<ol class="arabic simple">
<li><p>使用小程序登录微信公众平台，选择【访客登记通知】 &gt; 【消息模板】。
添加通知到个人模板库，记录模板 ID，供后续使用。</p></li>
</ol>
<blockquote>
<div><img alt="https://main.qcloudimg.com/raw/3e6445ef6f583409dd577242ff70eff0.png" src="https://main.qcloudimg.com/raw/3e6445ef6f583409dd577242ff70eff0.png" />
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>在小程序公众号平台， 选择【设置】&gt;【开发设置】，找到开发者密码（AppSecret） ，记录密码供后续使用。</p></li>
</ol>
<blockquote>
<div><img alt="https://main.qcloudimg.com/raw/2e5b9c342bd2bb1bce772cf4a6767ae7.png" src="https://main.qcloudimg.com/raw/2e5b9c342bd2bb1bce772cf4a6767ae7.png" />
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p>在公众号平台登录小程序绑定的公众号。</p></li>
</ol>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>在【首页】&gt;【功能】&gt;【添加功能】插件里选择模板消息，添加成功后，等待公众平台审核，审核通过后才能开始使用。</p></li>
<li><p>审核通过后，选择【来访申请提醒】模板，搜索结果列表中编号为 OPENTM410586240 ，添加提醒到个人模板库后，记录其 ID 供后续使用。</p></li>
</ol>
<img alt="https://main.qcloudimg.com/raw/eb9918c9ec5dd8e7839fa803309fc3e9.png" src="https://main.qcloudimg.com/raw/eb9918c9ec5dd8e7839fa803309fc3e9.png" />
</div></blockquote>
<ol class="arabic simple" start="4">
<li><p>在公众号管理平台，选择【开发】&gt;【基本配置】里找到开发者 appId ，记录 appId 供后续使用。</p></li>
</ol>
<blockquote>
<div><img alt="https://main.qcloudimg.com/raw/2cd31c0c5b4dc5d38e5aeb5726f6f54e.png" src="https://main.qcloudimg.com/raw/2cd31c0c5b4dc5d38e5aeb5726f6f54e.png" />
</div></blockquote>
<ol class="arabic simple" start="5">
<li><p>请按以下步骤操作：</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>首先在 cloud/functions 目录下，找到 send-message 云函数。</p></li>
<li><p>其次在其根目录下新建 config 目录，复制 example.js 到 config 下，并改名为 index.js 。</p></li>
<li><p>再而将上面收集保存的信息分别填入对应字段，内容如下所示。</p></li>
<li><p>然后上传并安装云函数依赖。</p></li>
</ul>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
<span class="nx">weappSecret</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1">// 小程序 secret ID</span>
<span class="nx">weappTemplateId</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1">// 小程序模板消息 ID</span>
<span class="nx">mpAppId</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1">// 公众号 appid</span>
<span class="nx">mpTemplateId</span><span class="o">:</span> <span class="s1">&#39;&#39;</span> <span class="c1">// 公众号模板消息 ID</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="6">
<li><p>打开云控制台，选择【数据库】&gt;【添加集合】 ，新建一个名为 <cite>reserves</cite> 的集合。
以上步骤全部完成后，您就可以编译预览体验本 <cite>demo</cite> 了。</p></li>
</ol>
</div>
<div class="section" id="id5">
<h2>7.3.5. 源码介绍<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<div class="section" id="id6">
<h3>7.3.5.1. 自定义消息模板<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
<p>发送模板消息，首先需要在模板库里选择对应的模板，并按需选择所需字段。
如果模板库中已有模板不能满足业务需求，您可以自己定义后提交审核，审核通过后即可选择使用。</p>
</div>
<div class="section" id="wx-js-utils">
<h3>7.3.5.2. 使用 wx-js-utils 发送模板消息<a class="headerlink" href="#wx-js-utils" title="永久链接至标题">¶</a></h3>
<p>官方的发送模板消息 API 如下所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>POST https://api.weixin.qq.com/cgi-bin/message/wxopen/template/send?access_token=ACCESS_TOKEN
</pre></div>
</div>
<p>具体的参数请参考 <a class="reference external" href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/template-message/sendTemplateMessage.html">小程序开发文档</a> 。</p>
<p>使用 <cite>wx-js-utils</cite> 封装方法，如下所示：</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">wxMiniUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WXMINIUser</span><span class="p">({</span> <span class="nx">appId</span><span class="p">,</span> <span class="nx">secret</span> <span class="p">});</span>
<span class="kr">const</span> <span class="nx">access_token</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">wxMiniUser</span><span class="p">.</span><span class="nx">getAccessToken</span><span class="p">();</span>

<span class="kr">const</span> <span class="nx">wxMiniMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WXMINIMessage</span><span class="p">({</span> <span class="nx">openId</span><span class="p">,</span> <span class="nx">formId</span><span class="p">,</span> <span class="nx">templateId</span> <span class="p">});</span>

<span class="k">return</span> <span class="nx">wxMiniMessage</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">({</span>
  <span class="nx">access_token</span><span class="p">,</span>
  <span class="nx">data</span><span class="p">,</span>
  <span class="nx">page</span>
<span class="p">});</span>
</pre></div>
</div>
<p>您只需要关注发布的消息内容即可。</p>
</div>
<div class="section" id="id8">
<h3>7.3.5.3. 统一服务消息<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<p>统一服务消息既可以发送小程序的模板消息，如有公众号与之绑定，则它也可以发送公众号模板消息，
此时只需要提供公众号的一些配置即可，详细的参数请查看 <a class="reference external" href="https://github.com/TencentCloudBase/tcb-demo-basic">DEMO</a> 代码。
通过消息发送的公众号推送消息，单击可以跳转到小程序页面，为小程序访问提供便利的入口。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>发送公众号模板消息也需要提前在公众号管理平台选择模板消息。</p>
</div>
<p>官方发送统一服务消息 API ，如下所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>POST https://api.weixin.qq.com/cgi-bin/message/wxopen/template/uniform_send?access_token=ACCESS_TOKEN
</pre></div>
</div>
<p>具体的参数请参考 <a class="reference external" href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/uniform-message/sendUniformMessage.html">小程序开发文档</a> 。</p>
<p>利用小程序发送绑定公众号的消息模板，必须是当前小程序已上线，不然接口始终会报如下错误。</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;errcode&quot;</span><span class="p">:</span><span class="mi">40165</span><span class="p">,</span><span class="nt">&quot;errmsg&quot;</span><span class="p">:</span><span class="s2">&quot;invalid weapp pagepath hint: [uQN5tA0640shc2]&quot;</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h3>7.3.5.4. 使用 wx-js-utils 接口发送统一服务消息<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h3>
<p>主要代码如下所示：</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">WXMINIUser</span><span class="p">,</span>
  <span class="nx">WXUniformMessage</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;wx-js-utils&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">touser</span><span class="p">,</span>
  <span class="nx">appId</span><span class="p">,</span>
  <span class="nx">secret</span><span class="p">,</span>
  <span class="nx">weapp_template_msg</span><span class="p">,</span>
  <span class="nx">mp_template_msg</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">event</span>

<span class="kr">const</span> <span class="nx">wxMiniUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WXMINIUser</span><span class="p">({</span> <span class="nx">appId</span><span class="p">,</span> <span class="nx">secret</span> <span class="p">});</span>
<span class="kr">const</span> <span class="nx">access_token</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">wxMiniUser</span><span class="p">.</span><span class="nx">getAccessToken</span><span class="p">();</span>

<span class="kr">const</span> <span class="nx">wxUniformMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WXUniformMessage</span><span class="p">();</span>

<span class="k">return</span> <span class="nx">wxUniformMessage</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">({</span>
  <span class="nx">access_token</span><span class="p">,</span>
  <span class="nx">touser</span><span class="p">,</span>
  <span class="nx">weapp_template_msg</span><span class="p">,</span>
  <span class="nx">mp_template_msg</span>
<span class="p">});</span>
</pre></div>
</div>
<p><cite>weapp_template_msg</cite> 和 <cite>mp_template_msg</cite> 的关系，两者都有。</p>
<ul class="simple">
<li><p>发送 <cite>weapp_template_msg</cite> 代表的小程序模板消息。</p></li>
<li><p><cite>weapp_template_msg</cite> 不存在而 <cite>mp_template_msg</cite> 存在时，则发送公众号模板消息。</p></li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="pay.html" class="btn btn-neutral float-right" title="7.4. 微信支付" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="qrcode.html" class="btn btn-neutral float-left" title="7.2. 小程序码" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Nosy

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>